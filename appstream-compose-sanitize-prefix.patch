From f9a0c85271ca057bf048e02b159bfdbdba547e75 Mon Sep 17 00:00:00 2001
From: Matthias Klumpp <matthias@tenstral.net>
Date: Mon, 16 May 2022 17:00:45 +0200
Subject: [PATCH] compose: Sanitize prefix value and verify all units for
 results

This helps https://github.com/flatpak/flatpak-builder/pull/418
---
 compose/asc-compose.c | 22 +++++++++++++++-------
 1 file changed, 15 insertions(+), 7 deletions(-)

diff --git a/compose/asc-compose.c b/compose/asc-compose.c
index 842b962c..a4dc4d2f 100644
--- a/compose/asc-compose.c
+++ b/compose/asc-compose.c
@@ -239,7 +239,12 @@ asc_compose_set_prefix (AscCompose *compose, const gchar *prefix)
 {
 	AscComposePrivate *priv = GET_PRIVATE (compose);
 	g_autoptr(GMutexLocker) locker = g_mutex_locker_new (&priv->mutex);
-	as_ref_string_assign_safe (&priv->prefix, prefix);
+
+	/* do a bit of sanitizing: "no prefix" means the prefix directory is the root directory */
+	if (prefix == NULL || g_strcmp0 (prefix, "") == 0)
+		as_ref_string_assign_safe (&priv->prefix, "/");
+	else
+		as_ref_string_assign_safe (&priv->prefix, prefix);
 }
 
 /**
@@ -1371,6 +1376,8 @@ asc_compose_process_task_cb (AscComposeTask *ctask, AscCompose *compose)
 	mi_fnames = g_ptr_array_new_with_free_func (g_free);
 	de_fname_map = g_hash_table_new_full (g_str_hash, g_str_equal,
 					      g_free, g_free);
+
+	g_debug ("Looking for metainfo files in: %s", metainfo_dir);
 	for (guint i = 0; i < contents->len; i++) {
 		const gchar *fname = g_ptr_array_index (contents, i);
 
@@ -2125,6 +2132,13 @@ asc_compose_run (AscCompose *compose, GCancellable *cancellable, GError **error)
 						     compose);
 	}
 
+	/* collect results */
+	for (guint i = 0; i < tasks->len; i++) {
+		AscComposeTask *ctask = g_ptr_array_index (tasks, i);
+		g_ptr_array_add (priv->results, g_object_ref (ctask->result));
+	}
+
+	/* check if we (unexpectedly) had no results */
 	if (g_hash_table_size (priv->allowed_cids) > 0 &&
 	    priv->results->len == 0 &&
 	    tasks->len > 0) {
@@ -2135,12 +2149,6 @@ asc_compose_run (AscCompose *compose, GCancellable *cancellable, GError **error)
 						"filters-but-no-output");
 	}
 
-	/* collect results */
-	for (guint i = 0; i < tasks->len; i++) {
-		AscComposeTask *ctask = g_ptr_array_index (tasks, i);
-		g_ptr_array_add (priv->results, g_object_ref (ctask->result));
-	}
-
 	/* write result */
 	if (priv->data_result_dir != NULL) {
 		if (!asc_compose_save_metadata_result (compose, error))
